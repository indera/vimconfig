# cat <<__DATA__ >/dev/null

set -gq default-terminal "xterm-256color"
set -gq history-limit 10000
set -gq display-time 1500
set -gq base-index 1
set -gq pane-base-index 1
set -gq repeat-time 1000
set -gq escape-time 50
set -gq mode-mouse copy-mode
set -gq mouse-select-pane on
set -gq word-separators ' -_@.'
set -gq aggressive-resize on

# Use correct shell
set -gq default-shell $SHELL

# Use different prefix
unbind 'C-b'
set -gq prefix 'C-\'
bind '\' send-prefix

# Use vim keys
setw -gq mode-keys vi

# vim-like visual selection
bind -t vi-copy 'v' begin-selection
bind -t vi-copy 'C-q' rectangle-toggle
bind -t vi-copy 'y' copy-selection
bind -t vi-copy 'V' select-line
bind 'C-]' paste-buffer

# Pipe pane to log file
bind 'h' pipe-pane -o "cat >>$HOME/#W-tmux#I.log" \; display-message \
    "Toggled logging to $HOME/#W-tmux#I.log"

# Enter copy mode in backward search prompt with C-_
bind -n 'C-_' run "(tmux display-message -p '#{pane_current_command}' \| grep -iqE '(^|\/)vim(diff)?$' && tmux copy-mode) || tmux copy-mode \\\; send-keys be"
bind 'C-_' send 'C-_'

# Change split window bindings
bind '%' choose-buffer
bind '=' split-window
bind '"' split-window -h

# Cycle between panes
bind -r 'Tab' select-pane -t :.+
bind -r 'BTab' select-pane -t :.-

# Don't need to release control to switch windows
bind -r 'C-Tab' next-window
bind -r 'C-S-Tab' previous-window

# Break pane with o ("only" current pane visible)
bind 'o' run "tmux break-pane \\\; swap-window -t$(tmux display-message -pF '#{window_id}')"
bind 'C-o' run "tmux break-pane \\\; swap-window -t$(tmux display-message -pF '#{window_id}')"

# Quit entire session with Q
bind 'Q' confirm-before -p "kill-session #W? (y/n)" kill-session

# Make ctrl+arrow keys work
setw -gq xterm-keys on

# Other bindings
bind 'M' show-messages
bind 'j' command-prompt -p "join pane from:" "join-pane -s '%%'"
bind 's' command-prompt -p "swap window with:" "swap-window -t '%%'"
bind 'm' command-prompt -p "move window to:" "move-window -t '%%'"
bind 't' source ~/.tmux.conf
bind 'C-t' source ~/.tmux.conf
bind -n 'C-l' refresh-client \; send-keys 'C-l'
bind 'l' last-window
bind 'C-l' last-window
bind '\;' last-window
bind "'" if "tmux last-pane" "" "if 'tmux select-pane -t :.+' 'send-keys \`' ''"
bind "\`" if "tmux last-pane" "" "if 'tmux select-pane -t :.+' 'send-keys \`' ''"
bind 'C-\' if "[[ $(tmux display-message -p '#{window_panes}') == 1 ]]" \
    'last-window' 'if "tmux last-pane" "" "select-pane -t :.+"'
bind ',' command-prompt "rename-window '%%'"
bind 'p' display-panes

# Colors for copy mode
setw -gq mode-fg black
setw -gq mode-bg blue

# Cygwin configuration
if 'test "$OSTYPE" = "cygwin"' 'run "cut -c3- ~/.tmux.conf | sh -s cygwin_bindings"'

# xclip copy/paste (preferred over Cygwin)
if 'command -v xclip >& /dev/null' 'run "cut -c3- ~/.tmux.conf | sh -s xclip_bindings"'

# Status bar configuration
run "cut -c3- ~/.tmux.conf | sh -s status_dark"
bind '-' run "cut -c3- ~/.tmux.conf | sh -s status_dark"
bind '+' run "cut -c3- ~/.tmux.conf | sh -s status_light"

# Toggle status bar
bind 'S' set -q status

# tmux navigator bindings
bind -n 'M-Left'  run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim(diff)?$' && tmux send-keys M-Left)  || tmux select-pane -L"
bind -n 'M-Down'  run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim(diff)?$' && tmux send-keys M-Down)  || tmux select-pane -D"
bind -n 'M-Up'    run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim(diff)?$' && tmux send-keys M-Up)    || tmux select-pane -U"
bind -n 'M-Right' run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim(diff)?$' && tmux send-keys M-Right) || tmux select-pane -R"

# Local configuration
if 'test -e ~/.tmux-local.conf' 'source ~/.tmux-local.conf'

# __DATA__
#
# cygwin_bindings() {
#     # Copy/paste from Cygwin clipboard
#     tmux bind -t vi-copy 'y' copy-pipe "tee /dev/clipboard"
#     tmux bind 'y' run "tmux show-buffer > /dev/clipboard"
#     tmux bind 'C-v' run 'tmux set-buffer "$(cat /dev/clipboard)"; tmux paste-buffer'
#     tmux bind ']'   run 'tmux set-buffer "$(cat /dev/clipboard)"; tmux paste-buffer'
#     tmux bind 'C-]' run 'tmux set-buffer "$(cat /dev/clipboard)"; tmux paste-buffer'
# }
#
# xclip_bindings() {
#     # Copy/paste from xclip
#     tmux bind -t vi-copy 'y' copy-pipe "xclip -i -sel p -f | xclip -i -sel c"
#     tmux bind 'y' run -b "tmux save-buffer - | xclip -i -sel p -f | xclip -i -sel c &"
#     tmux bind 'C-v' run 'tmux set-buffer "$(xclip -o)"; tmux paste-buffer'
#     tmux bind ']'   run 'tmux set-buffer "$(xclip -o)"; tmux paste-buffer'
#     tmux bind 'C-]' run 'tmux set-buffer "$(xclip -o)"; tmux paste-buffer'
# }
#
# status_dark() {
#     tmux set -g status-justify "centre" \; \
#          set -g status "on" \; \
#          set -g status-left-style "none" \; \
#          set -g message-command-style "fg=colour0,bg=colour12" \; \
#          set -g status-right-style "none" \; \
#          set -g pane-active-border-style "fg=colour4" \; \
#          set -g status-utf8 "on" \; \
#          set -g status-style "bg=colour0,none" \; \
#          set -g message-style "fg=colour0,bg=colour12" \; \
#          set -g pane-border-style "fg=colour12" \; \
#          set -g status-right-length "100" \; \
#          set -g status-left-length "100" \; \
#          setw -g window-status-activity-style "fg=colour4,bg=colour0,none" \; \
#          setw -g window-status-separator "" \; \
#          setw -g window-status-style "fg=colour12,bg=colour0,none" \; \
#          set -g status-left "#[fg=colour8,bg=colour4,bold] #S #[fg=colour4,bg=colour12,nobold,nounderscore,noitalics]#[fg=colour0,bg=colour12] #{?client_prefix,▲,#F} #[fg=colour12,bg=colour0,nobold,nounderscore,noitalics]#[fg=colour12,bg=colour0] #{pane_current_command} #[fg=colour0,bg=colour0,nobold,nounderscore,noitalics]" \; \
#          set -g status-right "#[fg=colour0,bg=colour0,nobold,nounderscore,noitalics]#[fg=colour12,bg=colour0] %a #[fg=colour12,bg=colour0,nobold,nounderscore,noitalics]#[fg=colour0,bg=colour12] %d%b%y  %R #[fg=colour4,bg=colour12,nobold,nounderscore,noitalics]#[fg=colour8,bg=colour4] #h " \; \
#          setw -g window-status-format "#[fg=colour0,bg=colour0,nobold,nounderscore,noitalics]#[default] #I#F  #W #[fg=colour0,bg=colour0,nobold,nounderscore,noitalics]" \; \
#          setw -g window-status-current-format "#[fg=colour0,bg=colour250,nobold,nounderscore,noitalics]#[fg=colour0,bg=colour250] #I#F  #W #[fg=colour250,bg=colour0,nobold,nounderscore,noitalics]" \; \
#          setw -g window-status-last-bg colour0 \; \
#          setw -g window-status-last-fg colour253 >& /dev/null
# }
#
# status_light() {
#     tmux set -g status-justify "centre" \; \
#          set -g status "on" \; \
#          set -g status-left-style "none" \; \
#          set -g message-command-style "fg=colour7,bg=colour11" \; \
#          set -g status-right-style "none" \; \
#          set -g pane-active-border-style "fg=colour4" \; \
#          set -g status-utf8 "on" \; \
#          set -g status-style "bg=colour7,none" \; \
#          set -g message-style "fg=colour7,bg=colour11" \; \
#          set -g pane-border-style "fg=colour11" \; \
#          set -g status-right-length "100" \; \
#          set -g status-left-length "100" \; \
#          setw -g window-status-activity-style "fg=colour4,bg=colour7,none" \; \
#          setw -g window-status-separator "" \; \
#          setw -g window-status-style "fg=colour11,bg=colour7,none" \; \
#          set -g status-left "#[fg=colour15,bg=colour4,bold] #S #[fg=colour4,bg=colour11,nobold,nounderscore,noitalics]#[fg=colour7,bg=colour11] #{?client_prefix,▲,#F} #[fg=colour11,bg=colour7,nobold,nounderscore,noitalics]#[fg=colour11,bg=colour7] #{pane_current_command} #[fg=colour7,bg=colour7,nobold,nounderscore,noitalics]" \; \
#          set -g status-right "#[fg=colour7,bg=colour7,nobold,nounderscore,noitalics]#[fg=colour11,bg=colour7] %a #[fg=colour11,bg=colour7,nobold,nounderscore,noitalics]#[fg=colour7,bg=colour11] %d%b%y  %R #[fg=colour4,bg=colour11,nobold,nounderscore,noitalics]#[fg=colour15,bg=colour4] #h " \; \
#          setw -g window-status-format "#[fg=colour7,bg=colour7,nobold,nounderscore,noitalics]#[default] #I#F  #W #[fg=colour7,bg=colour7,nobold,nounderscore,noitalics]" \; \
#          setw -g window-status-current-format "#[fg=colour7,bg=colour11,nobold,nounderscore,noitalics]#[fg=colour7,bg=colour11] #I#F  #W #[fg=colour11,bg=colour7,nobold,nounderscore,noitalics]" \; \
#          setw -g window-status-last-bg colour7 \; \
#          setw -g window-status-last-fg colour6 >& /dev/null
# }
#
# $1
